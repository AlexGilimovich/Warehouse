<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:context="http://www.springframework.org/schema/context"
             xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/security
       http://www.springframework.org/schema/security/spring-security.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <!--Transport company digest authentication-->
    <beans:bean id="transportCompanyDetailsService"
                class="com.itechart.warehouse.security.TransportCompanyDetailsService">
    </beans:bean>
    <beans:bean id="digestEntryPoint" class=
            "org.springframework.security.web.authentication.www.DigestAuthenticationEntryPoint">
        <beans:property name="realmName" value="Transport companies"/>
        <beans:property name="key" value="acegi"/>
    </beans:bean>
    <beans:bean id="digestFilter"
                class="org.springframework.security.web.authentication.www.DigestAuthenticationFilter">
        <beans:property name="userDetailsService" ref="transportCompanyDetailsService"/>
        <beans:property name="authenticationEntryPoint" ref="digestEntryPoint"/>
    </beans:bean>
    <http pattern="/api/**" use-expressions="false" create-session="stateless" authentication-manager-ref="api">
        <!--<intercept-url pattern="/api/**" access="hasRole(ROLE_TRUSTED_COMPANY)"/>-->
        <http-basic/>
        <custom-filter ref="digestFilter" after="BASIC_AUTH_FILTER"/>
    </http>


    <!--User form authentication-->
    <beans:bean id="userDetailsService"
                class="com.itechart.warehouse.security.WarehouseCompanyUserDetailsService">
    </beans:bean>
    <beans:bean id="userDigestEntryPoint" class=
            "org.springframework.security.web.authentication.www.DigestAuthenticationEntryPoint">
        <beans:property name="realmName" value="Warehouse clients"/>
        <beans:property name="key" value="acegi"/>
    </beans:bean>
    <beans:bean id="userDigestFilter"
                class="org.springframework.security.web.authentication.www.DigestAuthenticationFilter">
        <beans:property name="userDetailsService" ref="userDetailsService"/>
        <beans:property name="authenticationEntryPoint" ref="userDigestEntryPoint"/>
    </beans:bean>

    <http pattern="/web/**" use-expressions="true" create-session="stateless" authentication-manager-ref="web">
        <intercept-url pattern='/web/login/**' access="permitAll"/>
        <intercept-url pattern='/web/company/**' access="hasRole('ROLE_ADMIN')"/>
        <intercept-url pattern='/web/warehouse/**' access="hasRole('ROLE_SUPERVISOR')"/>
        <intercept-url pattern='/web/goods/**' access="hasAnyRole('ROLE_OWNER','ROLE_MANAGER')"/>
        <intercept-url pattern='/web/invoice/**'
                       access="hasAnyRole('ROLE_DISPATCHER','ROLE_CONTROLLER','ROLE_MANAGER')"/>
        <intercept-url pattern='/web/user/**' access="hasRole('ROLE_SUPERVISOR')"/>
        <intercept-url pattern='/web/tr-company/**' access="hasRole('ROLE_DISPATCHER')"/>
        <intercept-url pattern='/web/customer/**' access="hasRole('ROLE_DISPATCHER')"/>
        <intercept-url pattern='/web/finance/**' access="hasRole('ROLE_ADMIN')"/>
        <intercept-url pattern='/web/report/**' access="hasRole('ROLE_OWNER')"/>
        <intercept-url pattern='/web/act/**' access="hasAnyRole('ROLE_DISPATCHER','ROLE_CONTROLLER','ROLE_OWNER')"/>
        <intercept-url pattern='/web/settings/**' access="hasRole('ROLE_ADMIN')"/>
        <http-basic/>
        <custom-filter ref="userDigestFilter" after="BASIC_AUTH_FILTER"/>
        <csrf disabled="true"></csrf>
    </http>


    <authentication-manager id="web">
        <authentication-provider user-service-ref="userDetailsService"/>
    </authentication-manager>

    <authentication-manager id="api">
        <authentication-provider user-service-ref="transportCompanyDetailsService"/>
    </authentication-manager>
    <context:component-scan base-package="com.itechart.warehouse.security"/>


    <beans:bean id="permissionEvaluator" class="com.itechart.warehouse.security.SecurityPermissionEvaluator"/>

    <beans:bean id="methodSecurityExpressionHandler"
                class="org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler">
        <beans:property name="permissionEvaluator" ref="permissionEvaluator"/>
    </beans:bean>

    <global-method-security pre-post-annotations="enabled">
        <expression-handler ref="methodSecurityExpressionHandler"/>
    </global-method-security>

</beans:beans>